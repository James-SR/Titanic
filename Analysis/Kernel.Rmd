---
title: 'Exploring the Titanic Dataset :: Traditional approaches with new tools'
author: "James Solomon-Rounce"
date: ' 25th August 2016'
output:
  html_document:
    fig_height: 6
    fig_width: 8
    highlight: tango
    number_sections: yes
    theme: readable
    toc: yes
  pdf_document:
    toc: yes
---

# Introduction

This is my first attempt at a Kaggle kernel, Kaggle seems like a great site so wanted to make a foray.  Coming from a social science background my approach may seem a little 'old school' but shows how I would approach the modelling process, mixed in with some newer machine learning (aka predictive analytics) approaches.  Feedback welcome, thanks for taking the time to read.  

There are N parts to my script as follows:

* Exploratory Data Analysis aka EDA
* Feature engineering for prediction
* Where is my data or what to do with missing values
* Stick or caret - Predictions using multiple models 

## Load and check data

```{r, message = FALSE}
# Load packages
library('ggplot2')                                          # visualization
library('dplyr')                                            # data manipulation
library('Amelia')                                           # missing values
library('gridExtra')                                        # for nicely formatted tables
```

First lets combine the test and train datasets then get a feel for what data there is to work with.

```{r, message=FALSE, warning=FALSE}
train <- read.csv('Data/1.Raw/train.csv', stringsAsFactors = F)
test  <- read.csv('Data/1.Raw/test.csv', stringsAsFactors = F)

full  <- bind_rows(train, test)                             # bind training & test data

summary(full)                                               # check data
```

Here we can see that the summary makes sense for some variables - Age is a continous variable ranging from an infant (0.17 years) up to a possible grandfather (80 years), with 263 missing values (NAs). For other variables, such as the passenger's sex, whether they survived and their port of embarkation it would make more sense for these variables - currently a mix of numeric and charecter variables - to be groups of individuals, which in R are called factors aka categorical variables.  Classifying these variables correctly as factors will mean that any functions, plots or models will behave themselves correctly and produce the expected results.

```{r}
full$Survived <- factor(full$Survived, levels=c(1,0))
levels(full$Survived) <- c("Survived", "Died")
summary(full)                                              # re-check data
```


<<Discuss family make up>>

We've got a sense of our variables, their class type, and the first few observations of each. We know we're working with 1309 observations of 12 variables. Our first step is to get a feel for that data using EDA.

# Exploratory Data Analysis aka EDA
## What's in the data?

First, it is useful to know what is missing, we have already seen that for age there are 263 missing values but what about the other variables?  The Amelia package in R can not only help visualise what is in the data, but can also help fill in some of the blanks, more on that later.  The missmap function will create a 'map' of variable as columns and observations as rows, ordering the variables by the number of missing values.

```{r}
head(full)
missmap(full, col = c("grey","navy"))                     # first colour is missing, second is observed
```

As the test and train datasets have been combined together, the first variable with the highest degree of 'missingness' is Survived, since this relates to the test data.  The variable with the second highest degree of missing values is age, with quite a lot of missing values across both the test and train datasets. We can also explicitly count the number of NAs in a particular variable.

```{r}
NA_Count <- sapply(full, function(y) sum(is.na(y)))
NA_Count <- data.frame(NA_Count)                          # convert to a data frame
grid.table(NA_Count)                                      # produce the output table
```

As expected, Age does have the highest number of missing values (263), with only Fare having one other missing value.

Next we can begin to look at the variables in more detail.  First, let's see what the age distribution of survivors looks like, by Sex.

```{r}
ggplot(aes(y = Age, x = Sex, fill = Survived), data = full[1:891,]) + geom_boxplot() # we exclude the test data
```

Interestingly the average age of males who died is older than those who survived, whereas the situation is reversed for females, with the average age of females who died being younger than those who survived.

```{r}
sex_x_survived <-table(full[1:891,]$Sex, full[1:891,]$Survived)
grid.table(sex_x_survived)
chisq.test(sex_x_survived)
```

```{r}
hist(full$Age)
```

It looks like we have few over the age of 60, but let's group the cage ranges into groups or bins.  The other aspect to consider is that this is not normally distributed, we have a long tail to the right - it is right skewed.  For some models this may cause a problem, so it may be neccessary to transform this, porbably using a logarithmic transformation.   

```{r}
full$Agebin <- cut(full$Age, seq(0,90,10), right=FALSE, 
                   labels=c("Under 10", "10-19", "20-29", "30-39", "40-49", "50-59", "60-69", "70-79", "80-89")) 
                    # cuts age from 0 to 90 in groups/age bands of 10.  Could be made inclusive i.e. up to ten by using right=TRUE
Agebin_Freq <- cbind( Freq=table(full$Agebin), Cumul=cumsum(table(full$Agebin)), Proportion=prop.table(table(full$Agebin)))
Agebin_Freq <- transform(Agebin_Freq) # convert to a data frame, could also be achieved by Agebin_Freq <- data.frame(Agebin_Freq)
Agebin_Freq$Proportion <- paste(round(Agebin_Freq$Proportion * 100, digits=1),"%",sep="") # Decimal to a percent and round to 1 d.p.
grid.table(Agebin_Freq)                                   
```

As suspected, the actual number over the age of 60 is quite small, so lets combined the over 60s in to a single group.

```{r}
# Recode into over 60s factor, the second line moves the over 60s to the correct place at the end of the factors rather than the
# default which would return the 60 Plus BEFORE the Under 10s
full$Agebincmb <- recode_factor(full$Agebin, `60-69` = "60 Plus", `70-79` = "60 Plus", `80-89` = "60 Plus") 
full$Agebincmb <- ordered(full$Agebincmb, levels = c("Under 10", "10-19", "20-29", "30-39", "40-49", "50-59","60 Plus"))

#Same process for generating the table as before, but with the updated combined factor levels
Agebin_Freq <- cbind( Freq=table(full$Agebincmb), Cumul=cumsum(table(full$Agebincmb)), Proportion=prop.table(table(full$Agebincmb)))
Agebin_Freq <- transform(Agebin_Freq) 
Agebin_Freq$Proportion <- paste(round(Agebin_Freq$Proportion * 100, digits=1),"%",sep="") 
grid.table(Agebin_Freq) 
qplot(factor(Agebincmb), data=full[1:891,], geom="bar", fill=factor(Survived)) +
      geom_text(aes(label = Agebin_Freq$Proportion), size = 3, hjust = 0.5, vjust = 3, position =     "stack")
#Need to count the number of survived and died for each age group for creation of stacked bar above
#http://stackoverflow.com/questions/6644997/showing-data-values-on-stacked-bar-chart-in-ggplot2
#http://docs.ggplot2.org/current/geom_text.html
```

#works to create histogram and density plot, but need to add normal curve as a secondary density plot
ggplot (data=full[1:891,], aes(x=Age)) +
geom_histogram(aes(y=..density..)) +
geom_density(alpha=.2, fill= "red") 





#http://stackoverflow.com/questions/6967664/ggplot2-histogram-with-normal-curve
#works to create two density plots, one with a random normal 1000 samples one with...?
z <- rnorm(1000)

qplot(z, geom = "blank") + 

geom_histogram(aes(y = ..density..)) + 

stat_density(geom = "line", aes(colour = "bla")) + 

stat_function(fun=dnorm, aes(x = z, colour = "blabla")) + 

scale_colour_manual(name = "", values = c("red", "green"), 
                               breaks = c("bla", "blabla"), 
                               labels = c("kernel_est", "norm_curv")) 

#http://r.789695.n4.nabble.com/Howto-fit-normal-curve-into-histogram-using-GGPLOT2-td898609.html#
ggplot(mtcars, aes(x = mpg)) +
        geom_histogram(aes(y = ..density..), fill = "red") +
        stat_function(
                fun = dnorm,
                args = with(mtcars, c(mean = mean(mpg), sd = sd(mpg))))
        

